# GPT OFC Analyzer

Одностраничное веб-приложение для расчёта операционного финансового цикла (ОФЦ) и связанных коэффициентов ликвидности, рентабельности и устойчивости российских компаний. Данные запрашиваются в Checko API (поддерживается расширенный `extended` формат) с учётом суточного лимита, есть вспомогательные калькуляторы лимита и тест соединения без расхода квоты.

## Возможности
- Запрос финансовой отчётности по нескольким ИНН и набору периодов (годы или кварталы) с обязательными секциями баланса и ОПУ.
- Расчёт критических показателей: POI, PPD, PPA, OFC.
- Ликвидность: Current Ratio, Quick Ratio, Absolute Ratio.
- Рентабельность: ROA, ROE, Gross Margin, Net Margin.
- Финансовая устойчивость: Autonomy, Financial Leverage, Debt Ratio, D/E.
- Принудительный демо-режим для офлайн демонстрации (не активируется автоматически).
- Калькулятор требуемых запросов и отображение использованного/доступного лимита (по умолчанию 100 запросов/сутки).
- Проверка соединения с `api.checko.ru` без использования API-запросов.
- Переключатель светлой/тёмной темы прямо в интерфейсе (настройка сохраняется в браузере).

## Где указать API key Checko
- **Локально:** создайте файл `.env` (или экспортируйте в терминале) со строкой `CHECKO_API_KEY=ВАШ_КЛЮЧ` перед запуском `npm run start`.
- **Vercel:** Project → Settings → Environment Variables → добавьте переменную `CHECKO_API_KEY` (тип `Plaintext`), затем redeploy. Ключ не прошивается в код и не хранится в Git.

## Запуск локально
```bash
# 1) Установите Node.js (v18+). Внешние зависимости не требуются
# 2) Создайте .env с ключом Checko
export CHECKO_API_KEY=ВАШ_API_КЛЮЧ
export CHECKO_API_BASE=https://api.checko.ru/v3/companies

# 3) Старт сервера
npm run start
# или
node server.js
```
Приложение доступно на `http://localhost:3000`.

### Переменные окружения
- `PORT` — порт HTTP (по умолчанию 3000).
- `CHECKO_API_KEY` — ключ Checko API (обязателен для боевого режима).
- `CHECKO_API_BASE` — базовый URL Checko (по умолчанию `https://api.checko.ru/v3/companies`).
- `CHECKO_MOCK_MODE` — если `true`, принудительно использовать встроенные данные из `data/sample-financials.json`.
- `CHECKO_DAILY_LIMIT` — дневной лимит запросов (по умолчанию 100) для расчёта остатка.
- Переменные можно задать локально через `export` или на Vercel через Project → Settings → Environment Variables. Ключи не прошиваются в код.

## Деплой на Vercel
1. Создайте новый проект, подключите репозиторий.
2. Команда сборки для локальной проверки: `npm run start` (Node 18+). В облаке используется конфигурация `vercel.json`: она собирает функцию `api/index.js` через `@vercel/node` и публикует статику из `public/`.
3. В разделе Environment Variables добавьте `CHECKO_API_KEY` (и при необходимости `CHECKO_API_BASE`, `CHECKO_DAILY_LIMIT`).
4. После деплоя приложение будет доступно на корневом домене; фронтенд работает из `public/`, API — маршруты `/api/analyze`, `/api/quota`, `/api/estimate`, `/api/check-connection` (JSON-ответы без HTML, чтобы избежать ошибок вида «The page could not be found ... not valid JSON»).

## Формулы
- **POI** = 365 × ((Запасыᵗ + Запасыᵗ₋₁) / 2) / Себестоимость
- **PPD** = 365 × ((ДЗᵗ + ДЗᵗ₋₁) / 2) / Выручка
- **PPA** = 365 × ((КЗᵗ + КЗᵗ₋₁) / 2) / Себестоимость
- **OFC** = POI + PPD − PPA
- **Current Ratio** = Текущие активы / Текущие обязательства
- **Quick Ratio** = (Текущие активы − Запасы) / Текущие обязательства
- **Absolute Ratio** = Денежные средства / Текущие обязательства
- **ROA** = (Чистая прибыль / ((Активыᵗ + Активыᵗ₋₁) / 2)) × 100%
- **ROE** = (Чистая прибыль / ((Капиталᵗ + Капиталᵗ₋₁) / 2)) × 100%
- **Gross Margin** = ((Выручка − Себестоимость) / Выручка) × 100%
- **Net Margin** = (Чистая прибыль / Выручка) × 100%
- **Autonomy** = (Собственный капитал / Итого активы) × 100%
- **Financial Leverage** = Итого активы / Собственный капитал
- **Debt Ratio** = (Итого обязательства / Итого активы) × 100%
- **D/E Ratio** = Итого обязательства / Собственный капитал

## Структура проекта
- `server.js` — минимальный HTTP-сервер (Express-подобный) и маршруты API.
- `public/` — фронтенд (HTML, CSS, JS).
- `data/sample-financials.json` — встроенные данные для демо-режима.

## Примечания по интеграции с Checko API
- Базовый путь задаётся переменной `CHECKO_API_BASE`. Запрос формируется как `${CHECKO_API_BASE}/{ИНН}/financials?year={год}&quarter={квартал?}&period=quarter&key={API_KEY}&extended=1&sections=balance_sheet,income_statement,extended,...`.
- Обязательные секции (баланс, ОПУ и extended) добавляются автоматически; дополнительные секции управляются чекбоксами на форме.
- Обратите внимание на дневной лимит (100 запросов на бесплатном тарифе). Используйте калькулятор запросов (ИНН × число периодов) перед массовыми обращениями.
- Проверка соединения `/api/check-connection` не расходует лимит.

## Как разрешать merge-конфликты (Accept Incoming / Current / Both)
Если при мерже или rebase появляется конфликт, выбирайте вариант осознанно:

- **Accept Current Change** — оставить вашу локальную версию, если входящий патч дублирует или ухудшает текущий код/документацию.
- **Accept Incoming Change** — принять обновление из удалённой ветки, когда ваша копия устарела или неверна.
- **Accept Both Changes** — объединить правки, если они дополняют друг друга. После выбора обязательно вручную уберите маркеры конфликта и приведите текст/код к целостному виду.

Практический алгоритм:
1. Посмотрите контекст между маркерами `<<<<<<<`, `=======`, `>>>>>>>` и поймите, что меняет каждая сторона.
2. Выберите вариант (Current/Incoming/Both) по смыслу выше.
3. Если выбрали Both или нужно объединение, отредактируйте итог вручную.
4. Пересоберите/прогоните проверки и закоммитьте файл с разрешённым конфликтом.
